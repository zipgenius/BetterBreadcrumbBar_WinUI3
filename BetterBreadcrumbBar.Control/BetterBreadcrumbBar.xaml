<?xml version="1.0" encoding="utf-8"?>
<!--
    BetterBreadcrumbBar for WinUI 3
    Author:  Matteo Riso
    Version: 0.8.6
    Website: https://zipgenius.it
    Written with Claude AI
    License: MIT
-->
<UserControl
    x:Class="BetterBreadcrumbBar.Control.BetterBreadcrumbBar"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ctrl="using:BetterBreadcrumbBar.Control"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    SizeChanged="UserControl_SizeChanged">

    <UserControl.Resources>

        <!-- Shared style: nav buttons (Back / Up / Home / Overflow) — 28 x 28, transparent border -->
        <Style x:Key="NavIconButtonStyle" TargetType="Button">
            <Setter Property="Background"        Value="Transparent"/>
            <Setter Property="BorderBrush"       Value="Transparent"/>
            <Setter Property="BorderThickness"   Value="0"/>
            <Setter Property="Padding"           Value="0"/>
            <Setter Property="Width"             Value="28"/>
            <Setter Property="Height"            Value="28"/>
            <Setter Property="CornerRadius"      Value="4"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Grid>
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup x:Name="CommonStates">
                                    <VisualState x:Name="Normal"/>
                                    <VisualState x:Name="PointerOver">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames
                                                Storyboard.TargetName="Bg"
                                                Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0"
                                                    Value="{ThemeResource SubtleFillColorSecondaryBrush}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="Pressed">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames
                                                Storyboard.TargetName="Bg"
                                                Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0"
                                                    Value="{ThemeResource SubtleFillColorTertiaryBrush}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="Disabled">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames
                                                Storyboard.TargetName="Icon"
                                                Storyboard.TargetProperty="Opacity">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="0.36"/>
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                            <Border x:Name="Bg" CornerRadius="4" Background="Transparent"/>
                            <ContentPresenter x:Name="Icon"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"/>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Segment button style -->
        <!--
            FontSize is intentionally NOT set here so that the value inherited from
            BetterBreadcrumbBar (default 13) flows through without being blocked.
            All other text properties (FontFamily, FontWeight, FontStyle, FontStretch,
            Foreground, CharacterSpacing, TextDecorations) are TemplateBinding-forwarded
            from the Button to the ContentPresenter so they honour whatever the consumer
            sets on the UserControl.
        -->
        <Style x:Key="SegmentButtonStyle" TargetType="Button">
            <Setter Property="Background"        Value="Transparent"/>
            <Setter Property="BorderBrush"       Value="Transparent"/>
            <Setter Property="BorderThickness"   Value="0"/>
            <Setter Property="Padding"           Value="7,0"/>
            <Setter Property="Height"            Value="28"/>
            <Setter Property="CornerRadius"      Value="4"/>
            <Setter Property="VerticalAlignment" Value="Stretch"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Grid>
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup x:Name="CommonStates">
                                    <VisualState x:Name="Normal"/>
                                    <VisualState x:Name="PointerOver">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames
                                                Storyboard.TargetName="Bg"
                                                Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0"
                                                    Value="{ThemeResource SubtleFillColorSecondaryBrush}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="Pressed">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames
                                                Storyboard.TargetName="Bg"
                                                Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0"
                                                    Value="{ThemeResource SubtleFillColorTertiaryBrush}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                            <Border x:Name="Bg" CornerRadius="4" Background="Transparent"/>
                            <!--
                                TemplateBinding reads font properties from the Button
                                (TemplatedParent). Because the Button now has those values
                                set as LOCAL bindings from PathSegment (see DataTemplate),
                                TemplateBinding correctly forwards them to the text.
                            -->
                            <ContentPresenter
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                Margin="{TemplateBinding Padding}"
                                FontSize="{TemplateBinding FontSize}"
                                FontFamily="{TemplateBinding FontFamily}"
                                FontWeight="{TemplateBinding FontWeight}"
                                FontStyle="{TemplateBinding FontStyle}"
                                FontStretch="{TemplateBinding FontStretch}"
                                CharacterSpacing="{TemplateBinding CharacterSpacing}"/>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Chevron separator button style -->
        <Style x:Key="SeparatorButtonStyle" TargetType="Button">
            <Setter Property="Background"        Value="Transparent"/>
            <Setter Property="BorderBrush"       Value="Transparent"/>
            <Setter Property="BorderThickness"   Value="0"/>
            <Setter Property="Padding"           Value="3,0"/>
            <Setter Property="Width"             Value="22"/>
            <Setter Property="Height"            Value="28"/>
            <Setter Property="CornerRadius"      Value="4"/>
            <Setter Property="VerticalAlignment" Value="Stretch"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Grid>
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup x:Name="CommonStates">
                                    <VisualState x:Name="Normal"/>
                                    <VisualState x:Name="PointerOver">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames
                                                Storyboard.TargetName="Bg"
                                                Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0"
                                                    Value="{ThemeResource SubtleFillColorSecondaryBrush}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="Pressed">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames
                                                Storyboard.TargetName="Bg"
                                                Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0"
                                                    Value="{ThemeResource SubtleFillColorTertiaryBrush}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                            <Border x:Name="Bg" CornerRadius="4" Background="Transparent"/>
                            <ContentPresenter
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                Margin="{TemplateBinding Padding}"/>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Per-segment data template -->
        <!--
            Font properties are bound directly on the Button (not via TemplateBinding from
            ContentPresenter) because Button's default WinUI 3 theme ControlTemplate sets
            FontFamily locally via ThemeResource, which beats both inheritance and
            TemplateBinding. Setting the value on the Button itself is a LOCAL assignment
            that has higher priority than any Style or theme default.
        -->
        <DataTemplate x:Key="SegmentTemplate" x:DataType="ctrl:PathSegment">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Height="28"
                    Visibility="{x:Bind SegmentVisibility, Mode=OneWay}">
                <Button
                    Style="{StaticResource SegmentButtonStyle}"
                    Content="{x:Bind Label, Mode=OneWay}"
                    Tag="{x:Bind}"
                    Click="SegmentButton_Click"
                    ToolTipService.ToolTip="{x:Bind Node.FullPath, Mode=OneWay}"
                    FontFamily="{x:Bind FontFamily, Mode=OneWay}"
                    FontSize="{x:Bind FontSize, Mode=OneWay}"
                    FontWeight="{x:Bind FontWeight, Mode=OneWay}"
                    FontStyle="{x:Bind FontStyle, Mode=OneWay}"
                    FontStretch="{x:Bind FontStretch, Mode=OneWay}"
                    CharacterSpacing="{x:Bind CharacterSpacing, Mode=OneWay}"/>
                <Button
                    Style="{StaticResource SeparatorButtonStyle}"
                    Visibility="{x:Bind SeparatorVisibility, Mode=OneWay}"
                    Tag="{x:Bind}"
                    Click="SeparatorButton_Click"
                    ToolTipService.ToolTip="Show subfolders">
                    <Grid Width="16" Height="16">
                        <!--
                            ChevronGlyph is set by the control to E76C (›) in LTR
                            and E76B (‹) in RTL, because Segoe Fluent Icons chevrons
                            do not auto-mirror with FlowDirection.
                        -->
                        <FontIcon
                            Glyph="{x:Bind ChevronGlyph, Mode=OneWay}" FontSize="10"
                            Visibility="{x:Bind IsSeparatorLoading,
                                Converter={StaticResource BoolToInverseVisibilityConverter},
                                Mode=OneWay}"/>
                        <ProgressRing
                            Width="14" Height="14"
                            IsActive="{x:Bind IsSeparatorLoading, Mode=OneWay}"
                            Visibility="{x:Bind IsSeparatorLoading,
                                Converter={StaticResource BoolToVisibilityConverter},
                                Mode=OneWay}"/>
                    </Grid>
                </Button>
            </StackPanel>
        </DataTemplate>

    </UserControl.Resources>

    <!--
        Root layout: [Back?][Up?][Home?][│][Icon?][│][…?][›?][Segments…]
        The inline address AutoSuggestBox overlays the segments area when editing.
        Clicking the empty area of the bar activates editing mode.
        The outer Border carries the tooltip showing the current path.
    -->
    <Border
        x:Name="RootBorder"
        Background="{ThemeResource ControlFillColorDefaultBrush}"
        BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
        BorderThickness="1"
        CornerRadius="6"
        Padding="4,2"
        Height="36"
        PointerPressed="RootBorder_PointerPressed">

        <Grid>

            <!-- ── Main horizontal layout ── -->
            <StackPanel x:Name="NormalView"
                        Orientation="Horizontal"
                        VerticalAlignment="Center"
                        Spacing="0">

                <!-- Navigation buttons zone -->
                <StackPanel
                    x:Name="NavButtonsPanel"
                    Orientation="Horizontal"
                    VerticalAlignment="Center"
                    Spacing="1"
                    Visibility="Collapsed">

                    <!-- Back — E72B -->
                    <Button
                        x:Name="BackButton"
                        Style="{StaticResource NavIconButtonStyle}"
                        Visibility="Collapsed"
                        Click="BackButton_Click">
                        <FontIcon Glyph="&#xE72B;" FontSize="12"/>
                    </Button>

                    <!-- Up — E74A -->
                    <Button
                        x:Name="UpButton"
                        Style="{StaticResource NavIconButtonStyle}"
                        Visibility="Collapsed"
                        Click="UpButton_Click">
                        <FontIcon Glyph="&#xE74A;" FontSize="12"/>
                    </Button>

                    <!-- Home — E80F -->
                    <Button
                        x:Name="HomeButton"
                        Style="{StaticResource NavIconButtonStyle}"
                        Visibility="Collapsed"
                        Click="HomeButton_Click">
                        <FontIcon Glyph="&#xE80F;" FontSize="12"/>
                    </Button>

                </StackPanel>

                <!-- Divider after nav buttons -->
                <Rectangle
                    x:Name="NavSeparator"
                    Width="1" Height="16" Margin="3,0"
                    VerticalAlignment="Center"
                    Fill="{ThemeResource ControlStrokeColorDefaultBrush}"
                    Visibility="Collapsed"/>

                <!-- Leading icon zone -->
                <Border
                    x:Name="LeadingIconPresenter"
                    Visibility="Collapsed"
                    Padding="4,0,2,0"
                    VerticalAlignment="Center"/>

                <!-- Divider after icon -->
                <Rectangle
                    x:Name="IconSeparator"
                    Width="1" Height="16" Margin="3,0,2,0"
                    VerticalAlignment="Center"
                    Fill="{ThemeResource ControlStrokeColorDefaultBrush}"
                    Visibility="Collapsed"/>

                <!--
                    Overflow button (…): visible only when some leading segments
                    are hidden because the bar is too narrow.
                    Opens a flyout listing the hidden segments.
                -->
                <Button
                    x:Name="OverflowButton"
                    Style="{StaticResource NavIconButtonStyle}"
                    Visibility="Collapsed"
                    ToolTipService.ToolTip="Hidden segments"
                    Click="OverflowButton_Click">
                    <FontIcon Glyph="&#xE712;" FontSize="11"/>
                </Button>

                <!-- Chevron after the overflow button -->
                <FontIcon
                    x:Name="OverflowChevron"
                    Glyph="&#xE76C;" FontSize="10"
                    Margin="1,0,0,0"
                    VerticalAlignment="Center"
                    Visibility="Collapsed"/>

                <!-- Visible segments (clipped; overflow handled in code-behind) -->
                <ItemsControl
                    x:Name="SegmentsControl"
                    VerticalAlignment="Center"
                    ItemTemplate="{StaticResource SegmentTemplate}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>

            </StackPanel>

            <!-- ── Inline editing overlay ──
                 Visible only when the user clicks the empty area of the bar.
                 AutoSuggestBox fills the full width; Enter/Escape dismisses it;
                 clicks outside the bar are caught by a window-level handler.
            -->
            <AutoSuggestBox
                x:Name="InlineAddressBox"
                Visibility="Collapsed"
                VerticalAlignment="Center"
                HorizontalAlignment="Stretch"
                Margin="4,0"
                PlaceholderText="Type a path…"
                QueryIcon="Find"
                TextChanged="InlineAddressBox_TextChanged"
                SuggestionChosen="InlineAddressBox_SuggestionChosen"
                QuerySubmitted="InlineAddressBox_QuerySubmitted"
                KeyDown="InlineAddressBox_KeyDown"/>

        </Grid>
    </Border>

</UserControl>
